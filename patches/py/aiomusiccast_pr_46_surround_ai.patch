From 10995742664c292b8eb14c1a1ce4b2ccf64a328e Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?S=C3=B6ren=20Beye?= <github@hypfer.de>
Date: Sat, 28 Sep 2024 12:59:27 +0200
Subject: [PATCH] Add support for Surround AI

---
 aiomusiccast/capability_registry.py |  7 +++++++
 aiomusiccast/const.py               |  1 +
 aiomusiccast/features.py            |  1 +
 aiomusiccast/musiccast_data.py      |  1 +
 aiomusiccast/musiccast_device.py    | 11 +++++++++++
 aiomusiccast/pyamaha.py             | 17 +++++++++++++++++
 6 files changed, 38 insertions(+)

diff --git a/aiomusiccast/capability_registry.py b/aiomusiccast/capability_registry.py
index 31f8548..54661df 100644
--- a/aiomusiccast/capability_registry.py
+++ b/aiomusiccast/capability_registry.py
@@ -262,6 +262,13 @@ def normalize_option(option: object) -> str:
         lambda: device.data.zones[zone_id].surround_3d,
         lambda val: device.set_surround_3d(zone_id, val),
     ),
+    ZoneFeature.SURROUND_AI: lambda capability_id, device, zone_id: BinarySetter(
+        capability_id,
+        "Surround AI",
+        EntityType.CONFIG,
+        lambda: device.data.zones[zone_id].surround_ai,
+        lambda val: device.set_surround_ai(zone_id, val),
+    ),
 }


diff --git a/aiomusiccast/const.py b/aiomusiccast/const.py
index c40f896..8568146 100644
--- a/aiomusiccast/const.py
+++ b/aiomusiccast/const.py
@@ -48,6 +48,7 @@
     "mute": ZoneFeature.MUTE,
     "sound_program": ZoneFeature.SOUND_PROGRAM,
     "surround_3d": ZoneFeature.SURROUND_3D,
+    "surround_ai": ZoneFeature.SURROUND_AI,
     "direct": ZoneFeature.DIRECT,
     "pure_direct": ZoneFeature.PURE_DIRECT,
     "enhancer": ZoneFeature.ENHANCER,
diff --git a/aiomusiccast/features.py b/aiomusiccast/features.py
index 79e1204..6cf203b 100644
--- a/aiomusiccast/features.py
+++ b/aiomusiccast/features.py
@@ -64,6 +64,7 @@ class ZoneFeature(Feature):
     MUTE = auto()
     SOUND_PROGRAM = auto()
     SURROUND_3D = auto()
+    SURROUND_AI = auto()
     DIRECT = auto()
     PURE_DIRECT = auto()
     ENHANCER = auto()
diff --git a/aiomusiccast/musiccast_data.py b/aiomusiccast/musiccast_data.py
index d5c5527..234ac1e 100644
--- a/aiomusiccast/musiccast_data.py
+++ b/aiomusiccast/musiccast_data.py
@@ -179,6 +179,7 @@ def __init__(self):
         self.pure_direct: bool | None = None
         self.clear_voice: bool | None = None
         self.surround_3d: bool | None = None
+        self.surround_ai: bool | None = None

         self.surr_decoder_type: str | None = None

diff --git a/aiomusiccast/musiccast_device.py b/aiomusiccast/musiccast_device.py
index ed45b93..90c61d1 100644
--- a/aiomusiccast/musiccast_device.py
+++ b/aiomusiccast/musiccast_device.py
@@ -275,6 +275,7 @@ async def _fetch_zone(self, zone_id):
         zone_data.pure_direct = zone.get("pure_direct")
         zone_data.clear_voice = zone.get("clear_voice")
         zone_data.surround_3d = zone.get("surround_3d")
+        zone_data.surround_ai = zone.get("surround_ai")

         zone_data.surr_decoder_type = zone.get("surr_decoder_type")

@@ -670,6 +671,16 @@ async def set_surround_3d(self, zone_id, value):
         """Set 3d surround option."""
         await self.device.request(Zone.set_surround_3d(zone_id, value))

+    @_check_feature(ZoneFeature.SURROUND_AI)
+    async def set_surround_ai(self, zone_id, value):
+        """Set surround AI option."""
+        await self.device.request(
+            Zone.set_surround_ai(
+                zone_id,
+                value
+            )
+        )
+
     async def select_sound_mode(self, zone_id, sound_mode):
         """Select sound mode."""
         await self.device.request(Zone.set_sound_program(zone_id, sound_mode))
diff --git a/aiomusiccast/pyamaha.py b/aiomusiccast/pyamaha.py
index 16e2bdb..8c5deca 100644
--- a/aiomusiccast/pyamaha.py
+++ b/aiomusiccast/pyamaha.py
@@ -1037,6 +1037,7 @@ class Zone:
         "SET_SOUND_PROGRAM": "http://{host}/YamahaExtendedControl/v1/{zone}/setSoundProgram?program={program}",
         "PREPARE_INPUT_CHANGE": "http://{host}/YamahaExtendedControl/v1/{zone}/prepareInputChange?input={input}",
         "SET_SURROUND_3D": "http://{host}/YamahaExtendedControl/v1/{zone}/set3dSurround?enable={enable}",
+        "SET_SURROUND_AI": "http://{host}/YamahaExtendedControl/v1/{zone}/setSurroundAI?enable={enable}",
         "SET_DIRECT": "http://{host}/YamahaExtendedControl/v1/{zone}/setDirect?enable={enable}",
         "SET_PURE_DIRECT": "http://{host}/YamahaExtendedControl/v1/{zone}/setPureDirect?enable={enable}",
         "SET_ENHANCER": "http://{host}/YamahaExtendedControl/v1/{zone}/setEnhancer?enable={enable}",
@@ -1247,6 +1248,22 @@ def set_surround_3d(zone, enable):

     # end-of-method set_surround_3d

+    @staticmethod
+    def set_surround_ai(zone, enable):
+        """For setting Surround AI status.
+
+        Arguments:
+            @param zone: Specifies target Zone.
+                    Values: 'main', 'zone2', 'zone3', 'zone4'
+            @param enable: Specifies Surround AI status.
+        """
+        assert zone in ZONES, "Invalid ZONE value!"
+        return Zone.URI["SET_SURROUND_AI"].format(
+            host="{host}", zone=zone, enable=_bool_to_str(enable)
+        )
+
+    # end-of-method set_surround_ai
+
     @staticmethod
     def set_direct(zone, enable):
         """For setting Direct status.
